# SceneSearch 검색 원리

"Johnny Depp face"로 검색했을 때 어떻게 조니뎁 출연 장면을 찾는지 설명합니다.

---

## 검색 흐름 전체 그림

```
┌─────────────────────────────────────────────────────────────────────┐
│                        사전 준비 (1회)                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   🎬 영화 (Transcendence.mp4)                                       │
│         │                                                           │
│         ▼                                                           │
│   [ffmpeg 장면 감지]                                                │
│         │                                                           │
│         ▼                                                           │
│   🖼️ 1,125개 프레임 이미지                                          │
│         │                                                           │
│         ▼                                                           │
│   [CLIP 이미지 인코더]  ←── 각 프레임을 512차원 벡터로 변환          │
│         │                                                           │
│         ▼                                                           │
│   📦 embeddings.npz (1125 × 512 행렬)                               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                     실시간 검색 (매번)                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   👤 사용자: "Johnny Depp face"                                     │
│         │                                                           │
│         ▼                                                           │
│   [CLIP 텍스트 인코더]  ←── ~140ms                                  │
│         │                                                           │
│         ▼                                                           │
│   🔢 쿼리 벡터 (512차원)                                            │
│         │                                                           │
│         ▼                                                           │
│   [코사인 유사도 계산]  ←── ~0.5ms                                  │
│   쿼리 벡터 vs 1,125개 프레임 벡터                                  │
│         │                                                           │
│         ▼                                                           │
│   📊 유사도 점수 (1,125개)                                          │
│   [0.31, 0.12, 0.08, 0.29, 0.33, ...]                               │
│         │                                                           │
│         ▼                                                           │
│   [상위 8개 선택]                                                   │
│         │                                                           │
│         ▼                                                           │
│   🎯 결과: 프레임 #847 (01:02:03), #231 (00:17:45), ...             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 핵심: CLIP은 어떻게 "조니뎁"을 아는가?

### CLIP의 학습 방식

CLIP(Contrastive Language-Image Pre-training)은 OpenAI에서 만든 모델로, 인터넷에서 **4억 개의 (이미지, 텍스트) 쌍**으로 학습했습니다.

```
학습 데이터 예시:
┌──────────────────┬────────────────────────────┐
│ 이미지           │ 텍스트                      │
├──────────────────┼────────────────────────────┤
│ 🖼️ 조니뎁 사진   │ "Johnny Depp at premiere"  │
│ 🖼️ 연구실 사진   │ "laboratory equipment"     │
│ 🖼️ 폭발 장면     │ "explosion scene"          │
│ ...              │ ...                         │
└──────────────────┴────────────────────────────┘
```

**학습 목표**: 같은 쌍의 이미지-텍스트는 가깝게, 다른 쌍은 멀게 배치하도록 학습

### 결과: 공유 임베딩 공간

```
         512차원 벡터 공간

              "Johnny Depp"(텍스트)
                    ↓
                   ⭐ ← 텍스트 벡터
                  /
                 / (거리 가까움 = 유사도 높음)
                /
         🔵 🔵 🔵  ← 조니뎁 얼굴 프레임들




    🟢 🟢  ← 연구실 프레임들
              \
               \ (거리 멂 = 유사도 낮음)
                \
                 ⭐ ← "laboratory" 텍스트 벡터
```

**이미지와 텍스트가 같은 공간에 있어서** 직접 비교가 가능합니다!

---

## 코사인 유사도 계산

두 벡터가 얼마나 같은 방향을 가리키는지 측정합니다.

```python
# 쿼리 벡터 (512차원)
query = [0.12, -0.34, 0.56, 0.01, ..., -0.23]

# 프레임 #847 벡터 (조니뎁 얼굴)
frame_847 = [0.11, -0.32, 0.54, 0.02, ..., -0.21]

# 프레임 #123 벡터 (연구실 장면)
frame_123 = [-0.45, 0.12, -0.08, 0.33, ..., 0.67]
```

```
코사인 유사도 = (벡터A · 벡터B) / (|A| × |B|)

query vs frame_847 = 0.33  ← 높음! (방향 비슷)
query vs frame_123 = 0.08  ← 낮음 (방향 다름)
```

### 실제 코드

```python
similarities = embeddings @ text_emb  # 행렬 곱 = 모든 프레임과 한번에 비교
# 결과: [0.08, 0.12, 0.05, ..., 0.33, ..., 0.29]  (1,125개 점수)

top_indices = np.argsort(similarities)[::-1][:8]  # 높은 순으로 8개
# 결과: [847, 231, 445, 892, ...]  (조니뎁 얼굴 프레임 인덱스들)
```

---

## 구체적인 예시

"Johnny Depp face"로 검색했을 때:

| 순위 | 프레임 | 타임스탬프 | 유사도 | 실제 장면 |
|------|--------|------------|--------|-----------|
| 1 | #847 | 01:02:03 | 0.33 | 조니뎁 정면 클로즈업 |
| 2 | #892 | 01:05:41 | 0.31 | 조니뎁 측면 |
| 3 | #231 | 00:17:45 | 0.29 | 조니뎁 대화 장면 |
| ... | ... | ... | ... | ... |
| 1120 | #45 | 00:03:12 | 0.02 | 빈 연구실 |

CLIP이 "Johnny Depp"이라는 텍스트와 **시각적으로 조니뎁이 나오는 프레임**이 비슷한 벡터를 갖도록 학습돼있어서 가능합니다!

---

## 파일 저장 구조

### embeddings.npz (NumPy 압축 포맷)

```python
{
    'embeddings': (1125, 512),  # 프레임 벡터들 (약 2.2MB)
    'timestamps': (1125,)       # 타임스탬프 (초 단위)
}
```

### metadata.json

```json
{
    "frames": [
        {
            "index": 0,
            "filename": "frame_0001.jpg",
            "timestamp": 5.672,
            "time_str": "00:05"
        },
        ...
    ]
}
```

---

## 성능 측정

| 구분 | 시간 | 설명 |
|------|------|------|
| 텍스트 인코딩 | ~140ms | CLIP으로 쿼리 텍스트 → 512차원 벡터 |
| 벡터 검색 | ~0.5ms | 1,125개 프레임과 유사도 계산 + 정렬 |

1,125개 프레임 수준에서는 FAISS 같은 벡터 DB 없이 numpy만으로도 충분히 빠릅니다.

---

## 한계점

1. **CLIP이 모르는 건 못 찾음**
   - "내 친구 철수" → CLIP이 철수를 모름
   - 유명인, 일반적인 물체/장면은 잘 찾음

2. **영어가 더 정확함**
   - "조니뎁" < "Johnny Depp" (CLIP이 영어로 학습됨)

3. **추상적 개념은 어려움**
   - "슬픈 장면", "긴장감 있는 순간" → 애매함
